<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Condensed);
      @import url(https://fonts.googleapis.com/css?family=PT+Sans:400,700);

      body { 
        font-family: 'Yanone Kaffeesatz';
        color: #fff;
      }
      
      h1, h2, h3 {
        font-weight: normal;
        text-transform: uppercase;
      }

      .pin img {
        position: absolute;
        right: 0;
        top: 0;
        width: 300px;
      }

      h1 {
        font-size: 4em !important;
      }

      .spanny {
        padding: 10px;
        color: white;
        background-color: #0b1c2e
      }

      strong {
        font-weight: normal;
        color: #28c4c9;
      }

      .nopadding {
        padding: 0
      }

      .fade {
        color: #223d5a;
      }

      .quote-author h3, .quote-author h2 {
        text-align: right;
      }

      .findbugs img {
        height: 500px;
      }

      .findbugs p {
        text-align: center;
      }

      .remark-slide-content {
        background-color: #0b1c2e;
        background-size: 100% 100%
      }

      .whitebg {
        background-color: white;
      }

      .blackbg {
        background-color: black;
      }

      .splash { 
        position: absolute;
        right: 3em;
        bottom: 3em;
        color: #EEE;
        text-align: right;
      }

      .splash big {
        font-size: 2.5em;
      }

      .splash small {
        font-size: 1.6em;
      }

      .splash img {
        width: 40px;
        margin-right: 10px;
        vertical-align: middle;
      }

      .smelling-symptoms h3 {
          margin: 20px 0;
      }

      .smelling-symptoms .left-column {
        width: 20%;
        float: left;
      }
      
      .smelling-symptoms .right-column {
        width: 75%;
        float: right;
      }      

      .packages pre {
        font-size: 2em;
      }

      .packages pre code {
       font-size: 0.7em; 
      }

      .packages pre strong {
        font-weight: bold;
      }

      a {
        color: #28c4c9;
      }

      .more img {
          width: 200px;
          margin-right: 10px;
      }

      .more .left-column {
        width: 55%;
        float: left;
      }
      
      .more .right-column {
        width: 45%;
        float: right;
      }      

      .equal-cols .left-column {
        width: 50%;
        float: left;        
      }

      .equal-cols .right-column {
        width: 50%;
        float: right;        
      }

      .thanks h1 {
        font-size: 150px !important;
      }

      .arrows {
        color: #0b1c2e;
        font-weight: bold;
      }

      .hljs-default .hljs {
        background-color: white;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle, title
background-image: url(splash.jpg)

# Architecting **well-structured**  Java applications

  <div class="splash">
    <big>Eduards Sizovs</big>
    <br/>
    <img src="twitter.png"><small>@eduardsi</small>
  </div>

---
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.0)), url(cat.jpg)
# .txt[Most apps begin life small and neat.]

---

# Time goes by...

---
class: center, middle
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(monster.jpg)

# Hello. I am your rotting enterprise app.

---
class: smelling-symptoms
background-image: url(shit.png)
# Smelling symptoms ->

.left-column[
## - Rigidity
## - Fragility
## - Immobility
## - Viscosity
]
.right-column[
## - Opacity
## - Needless Complexity
## - Needless Repitition
]
???
Rigidity (стойкость) – изменение аффектит слишком много зависимостей (МНОГО ЗАВИСИМОСТЕЙ ОТ МОДУЛЯ)
Fragility (хрупкость) – поломка в разных местах без конфептуальной связи
Immobility (немобильность, тяжеловесность) – невозможность зареюзать компоненты, хвост зависимостей, сложно сделать декомпозицию (МНОГО ТЯНЕТ ЗА СОБОЙ КУЧУ)
Viscosity (вязкость) – when normal change is harder to employ than hack due to design (not clear wtf) or environment (compilation 1H)
Opacity – не понятна суть и предназначение артифакта, взаимосвязи
Needless Complexity – чтобы сделать что-нибудь, приходится городить
Needless Repetition – один и тот же функционал в разных кодовых проявлениях


---
class: nopadding
background-image: url(hibernate.png)
### .spanny[Hibernate Core v4.3.8.Final]

---
class: nopadding, whitebg
background-image: url(jdk7.png)
### .spanny[JDK v1.7.0_51]

---
class: quote-author
> ## **A JDK code base is deeply interconnected** at both the API and the implementation levels, having been built over many years primarily in the style of a monolithic software system. We’ve spent considerable effort eliminating or at least simplifying as many API and implementation dependences as possible, so that both the Platform and its implementations can be presented as a coherent set of interdependent modules, but some particularly thorny cases remain. 
>### (c) Mark Reinholds, Chief Architect of the Java Platform

???
- Why is modularizing the JDK so hard?
- Besides other benefits, well-managed software structure gives you huge flexibility in future. Structure can evolve.

---
class: nopadding, whitebg
background-image: url(spring.png)
### .spanny[Spring v4.1.6]
???
More 12.5 years of successful framework evolution without big-bang rewrites. I wish your app lived that long.

---
# Principles.

---
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(box.jpg)
# Package is the **first-class citizen** and key element of logical design. 

---
class: blackbg
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(hierarchy.jpg)
# Treat packages as a **hierarchy** even if they’re represented flat.

---
class: middle, packages
<pre>
io.shwitter.user
io.shwitter.user.registration
io.shwitter.user.profile
io.shwitter.timeline
</pre>
&nbsp;
???
- Being Related != Part of
- Packages under Client can be tightly coupled. With an API around.
-  An Aggregate Root with aggregates + functions
- Or a Bounded context, for example.



---
class: middle, packages
<pre>
io.**shwitter**.**user**               (part of)
io.shwitter.user.registration
io.shwitter.user.profile
io.shwitter.timeline
</pre>
&nbsp;
---

class: middle, packages
<pre>
io.shwitter.user
io.shwitter.**user**.**registration**  (part of)
io.shwitter.user.profile 
io.shwitter.timeline
</pre>
&nbsp;

---

class: middle, packages
<pre>
io.shwitter.user
io.shwitter.user.registration
io.shwitter.**user**.**profile**       (part of)
io.shwitter.timeline
</pre>
&nbsp;

---
class: middle, packages
<pre>
io.shwitter.user
io.shwitter.user.registration    
io.shwitter.user.profile
io.**shwitter**.**timeline**             (part of)
</pre>
&nbsp;
???
- Being Related != Part of
- Packages under user can be tightly coupled. With an API around.
-  An Aggregate Root with aggregates + functions
- Or a Bounded context, for example.

---
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(applesoranges.jpg)
# Use packages to group functionally-related artifacts. Do not group artifacts that do the same thing, but are different by nature.

---
class: packages
<pre>
io.shwitter.controller
io.shwitter.dao
io.shwitter.domain
io.shwitter.services
io.shwitter.exceptions
</pre>

---
class: packages
<pre>
io.shwitter.**controller**
io.shwitter.dao
io.shwitter.domain
io.shwitter.services
io.shwitter.exceptions

**UserController**, **TimelineController**...
</pre>
&nbsp;

---
class: packages
<pre>
io.shwitter.controller
io.shwitter.**dao**
io.shwitter.domain
io.shwitter.services
io.shwitter.exceptions

**UserDAO**, **TimelineDAO**...
</pre>
&nbsp;

---
class: packages
<pre>
io.shwitter.controller
io.shwitter.dao
io.shwitter.**domain**
io.shwitter.services
io.shwitter.exceptions

**User**, **Timeline**...
</pre>
&nbsp;

---
class: packages
<pre>
io.shwitter.controller
io.shwitter.dao
io.shwitter.domain
io.shwitter.**services**
io.shwitter.exceptions

**RegistrationService**, **TimelineService**...
</pre>
&nbsp;

---
class: packages
<pre>
io.shwitter.controller
io.shwitter.dao
io.shwitter.domain
io.shwitter.services
io.shwitter.**exceptions**
</pre>
&nbsp;

---
class: packages
<pre class="fade">
io.shwitter.controller
io.shwitter.dao
io.shwitter.domain
io.shwitter.services
io.shwitter.exceptions
</pre>
<pre>
io.shwitter.user
io.shwitter.user.registration
io.shwitter.user.profile
io.shwitter.timeline  
</pre>

---
class: packages
<pre class="fade">
io.shwitter.controller
io.shwitter.dao
io.shwitter.domain
io.shwitter.services
io.shwitter.exceptions

</pre>
<pre>
io.shwitter.**user**
io.shwitter.user.registration
io.shwitter.user.profile
io.shwitter.timeline  

**User**, **UserDAO**, **UserController**...
</pre>&nbsp;
???
It’s not about slices-first/layers-first fighting. It’s about grouping artifacts that are closely related.
“DDD” packaging
Functional components are not visible at all. How to find relations between functional items. “What if I add this, how would it impact my functionality”?
What should I do to extract functionality into a separate module? 
FAT is high that will force you to break logical module into functional. Then you’ll end up with mess managing this layering.
Ok, provide API on top.
POSMOTRI SA ANTI-PATTERNS ZAODNO.

---
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(chain.jpg)
# Group tightly coupled classes together. If classes that change together are in the same package, then the impact of change is localized. 
# - **The Common Closure Principle**
???
Shotgun surgery instead of localized changes (imagine I move user somewhere). 
Imagine I put a class that changes frequently into unrelated package. It will change every time as well!

---
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(escape.jpg)
# Make sure artifacts do not escape.


---
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(waste.gif)
# Make packages highly cohesive by following Single Responsibility Principle.

---
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(rope.jpg)
# Keep packages loosely coupled, ideally – completely independent. Reflection doesn’t count.
???
I gain portability!!!
For example, when mapping relationships, map using ID instead of Entity.
Independence – talk to as few as possible. We become mobile, don’t care about incoming/outgoing dependencies

---
class: packages
```java
  package io.shwitter.user

  @Entity
  class User {
    // name, password etc.
  }
```

```java
  package io.shwitter.timeline

  @Entity
  class Timeline {
    @OneToOne User user;
  }
```

---
class: packages
```java
  package io.shwitter.user

  @Embeddable
  class UserId {
    Long value;
  }
```

```java
  package io.shwitter.timeline

  @Entity
  class Timeline {
    @Embedded UserId userId;
  }
```

---
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(iceberg.jpg)
# Provide slim package interface and hide implementation details.
???
Be conservative in what you expose.
Introduce factories that hide implementations (Dependency Injection, Service Locators etc.)
Make @Components package-private
Separate “api” from “internal” packages and restrict access to “internal”
Make sure “internal” depends on “api”, not opposite.
Murphy’s law on being conservative exposers: if programmer can, he will (don’t expose Client to others). From the other hand, it’s more complex + refactoring is supported within app. So doesn’t make sense.

---
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(magnets.png)
# Avoid dependency magnets. Sometimes duplication is not that evil.
???
E.g. Client is used everywhere! Consider creating different clients. Ideally client can have different forms: Visitor, Client, Lender… 
Break client into smaller parts
Abstract if there is chance that client code will have different cadence (out of release scope)

---
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(arrows.png)
# Manage relationships. Every dependency arrow has a reason. 

---
class: nopadding, whitebg, findbugs
## .spanny[Findbugs V1.0 - A great start]
![](findbugs10.png)

---
class: nopadding, whitebg, findbugs
## .spanny[Findbugs V1.1 – Imperfection creeps in]
![](findbugs11.png)

---
class: nopadding, whitebg, findbugs
## .spanny[Findbugs V1.2 – Imperfection takes hold]
![](findbugs12.png)

---
class: nopadding, whitebg, findbugs
## .spanny[Findbugs V1.3 – Chaos begins]
![](findbugs13.png)

---
class: nopadding, whitebg, findbugs
## .spanny[Findbugs V1.4 – Explosion]
![](findbugs14.png)

---
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(tailchase.jpg)
# The dependencies between packages must not form cycles. Burn bi-directional dependences in fire. 
???
Visual thinking is very effective. Visual relationship must be obvious and occurate, otheriwse I have to go back and forth to understand the idea. You can’t build simple mental model because arrows go to both directions.
---
# How?

---
class: packages, nopadding, whitebg, pin
## .spanny[Merging]
```java
package io.shwitter.user
class User { 
  void register(RegistrationNotifier notifier) {}
}
```
```java
package io.shwitter.user.notify
class RegistrationNotifier { 
  void notify(User user) {}
}
```
![](bidi1.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Merging - Repackaging]
```java
package io.shwitter.user
class User { 
  void register(RegistrationNotifier notifier) {}
}

class RegistrationNotifier { 
  void notify(User user) {}
}
```
![](merged.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Dependency Inversion]
```java
package io.shwitter.user
class User { 
  void register(RegistrationNotifier notifier) {}
}
```
```java
package io.shwitter.user.notify
class RegistrationNotifier { 
  void notify(User user) {}
}
```
![](bidi1.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Dependency Inversion - Refactoring Step 1]
```java
package io.shwitter.user
class User { 
  void register(RegistrationNotifier notifier) {}
}
```
```java
package io.shwitter.user.notify
class RegistrationNotifier implements UserNotifier { 
  void notify(User user) {}
}
interface UserNotifier {
  void notify(User user) {}  
}
```
![](invert2.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Dependency Inversion - Refactoring Step 2]
```java
package io.shwitter.user
class User { 
  void register(UserNotifier notifier) {}
}
```

```java
package io.shwitter.user.notify
class RegistrationNotifier implements UserNotifier { 
  void notify(User user) {}
}
interface UserNotifier {
  void notify(User user) {}  
}
```
![](invert2.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Dependency Inversion - Refactoring Step 3]
```java
package io.shwitter.user
class User { 
  void register(UserNotifier notifier) {}
}
interface UserNotifier {
  void notify(User user) {}  
}
```

```java
package io.shwitter.user.notify
class RegistrationNotifier implements UserNotifier { 
  void notify(User user) {}
}
```
![](invert3.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Escalation]
```java
package io.shwitter.user
class User { 
  void register(Notifier n) { n.notify(this); }
}
```
```java
package io.shwitter.user.notify
class Notifier { 
  void notify(User user) { sendEmailTo(user.email()); }
}
```
![](esc.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Escalation - Refactoring Step 1]
```java
package io.shwitter.user
class User { 
  void register(Notifier n) { n.notify(this); }
}
```
```java
package io.shwitter.user.notify
class Notifier { 
  void notify(User user) { sendEmailTo(user.email()); }
}
```
```java
package io.shwitter.user.registration
class Registrator {
  void register(User user, Notifier n) {}
}
```
![](esc1.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Escalation - Refactoring Step 2]
```java
package io.shwitter.user
class User { 
  void register() { }
}
```
```java
package io.shwitter.user.notify
class Notifier { 
  void notify(User user) { sendEmailTo(user.email()); }
}
```
```java
package io.shwitter.user.registration
class Registrator {
  void register(User user, Notifier n) { n.notify(user); }
}
```
![](esc2.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Escalation - Refactoring Step 3]
```java
package io.shwitter.user
class User { 
  void register() { }
}
```
```java
package io.shwitter.user.notify
class Notifier { 
  void notify(String emailAddress) { sendEmailTo(emailAddress); }
}
```
```java
package io.shwitter.user.registration
class Registrator {
  void register(User user, Notifier n) { n.notify(user.email()); }
}
```
![](esc3.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Demotion]
```java
package io.shwitter.user
class User { 
  void register(Notifier n) { n.notify(this); }
}
```
```java
package io.shwitter.user.notify
class Notifier { 
  void notify(User user) { sendEmailTo(user.email()); }
}
```
![](demotion.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Demotion - Refactoring Step 1]
```java
package io.shwitter.user
class User implements EmailHolder { 
  void register(Notifier n) { n.notify(this); }
}
```
```java
package io.shwitter.user.notify
class Notifier { 
  void notify(User user) { sendEmailTo(user.email()); }
}
```
```java
package io.shwitter.emailer
interface EmailHolder  { 
  String email();
}
```
![](demotion1.png)

---
class: packages, nopadding, whitebg, pin
## .spanny[Demotion - Refactoring Step 2]
```java
package io.shwitter.user
class User implements EmailHolder { 
  void register(Notifier n) { n.notify(this); }
}
```
```java
package io.shwitter.user.notify
class Notifier { 
  void notify(EmailHolder emailHolder) { sendEmailTo(emailHolder.email()); }
}
```
```java
package io.shwitter.emailer
interface EmailHolder  { 
  String email();
}
```
![](demotion2.png)



???
Reasons:
No guidelines for developers.
Unable to simply extract: unable to “levelize” to see what to physically extract for build parallelization


---
# Tools

---
background-image: url(macker.png)

---
class: whitebg, nopadding, packages
## .spanny[Macker example]
```xml
<?xml version="1.0"?>
<macker>    
    <ruleset name="Simple example">
        <access-rule>
            <deny>
                <from class="**Print*" />
                <to class="java.**" />
            </deny>
        </access-rule>
    </ruleset>
</macker>
```
---
background-image: url(classycle.png)

---
class: whitebg, nopadding, packages
## .spanny[Classycle example]
```xml
#
# This is an example of a dependency definition file
#
show allResults

{package} = classycle

[util] = ${package}.util.*
[non-util] = ${package}.* excluding [util]
[class-file] = ${package}.classfile.*

check sets [util] [non-util] [class-file]

check [util] independentOf [non-util]
check [class-file] independentOf [util]
```

---
background-image: url(veripacks.png)
???
Java doesn’t have packages. Package is self-contained unit with a boundaries. Java has only namespaces which leads to insane amount of coupling.

---
background-image: url(s101.png)

---
background-image: url(stan.png)


---
class: more
# More
.left-column[
- OO Design Principles &amp; Metrics, Jason Gorman http://goo.gl/RTW9GT
- The Economics of Software Design, J.B. Rainsberger http://goo.gl/ra7Q8Q 
- SOLID Principles, Eduards Sizovs http://goo.gl/Rpxavd
- Designing Object-Oriented Software, Jouni Smed http://goo.gl/iyE1R2
- Grand Unified Theory Of Software Design, Jim Weirich http://goo.gl/ASqyAs
- Fun With Modules, Kirk Knoernschild http://goo.gl/i8jx8Y
- Patterns of Modular Architecture http://goo.gl/yFqmZO
- Let’s turn packages into a module system! http://goo.gl/Mzco8F
]


.right-column[
![](java_app_arch.jpg)
![](ppp.jpg)
]

---
class: quote-author
> # Either you work to create a company culture or you don't. Either way a culture will emerge.
>## (c) Martin Linkhorst


---
class: quote-author
> # Either you work to create a software structure or you don't. Either way a structure will emerge.
>## (c) Eduards Sizovs

---
class: nopadding, center, middle, thanks
background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(applause.gif)
# Thank you


    </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({ 
            ratio: '16:9', 
            slideNumberFormat: function (current, total) { return "" } 
      });
    </script>
  </body>
</html>